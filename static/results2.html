<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Abstimmung â€“ Ergebnisse</title>
    <style>
        /* Basic page setup */
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            background: black;
            color: white;
            font-family: Arial, Helvetica, sans-serif;
        }

        #chart-container {
            height: 100vh;
            width: 90%;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 24px;
            background: black;
            align-items: stretch;
        }

        #chart {
            display: flex;
            flex-direction: column;
            gap: 24px;
            width: 100%;
            flex: 1;
            overflow-y: auto;
        }

        /* One row per candidate - EXPANDED to fill space */
        .bar-row {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 140px;
        }

        /* WINNER ROW - emphasized */
        .bar-row.winner {
            border: 6px solid #FFD700;
            background: rgba(255, 215, 0, 0.1);
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
        }

        /* Winner text styling */
        .bar-row.winner .bar-name {
            color: #FFD700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
        }

        .bar-row.winner .bar-votes {
            color: #FFD700;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.6);
        }

        /* Top row: Name + Votes side by side - taller */
        .bar-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 8px;
            height: 56px;
        }

        /* Candidate name - LARGE & READABLE */
        .bar-name {
            font-size: 125px;
            font-weight: bold;
            line-height: 1.2;
            flex: 1;
        }

        /* Votes next to name */
        .bar-votes {
            font-size: 75px;
            opacity: 0.8;
            white-space: nowrap;
        }

        /* Bar container - fills ALL remaining space */
        .bar-container {
            flex: 1;
            display: flex;
            align-items: center;
            position: relative;
            min-height: 70px;
        }

        /* Horizontal bar background - taller */
        .bar-bg {
            flex: 1;
            height: 80px;
            border: 4px solid white;
            background: transparent;
            display: flex;
            align-items: center;
            padding: 0;
            box-sizing: border-box;
        }

        /* Winner bar - special styling */
        .bar-row.winner .bar-bg {
            border-color: #FFD700;
            box-shadow: inset 0 0 20px rgba(255, 215, 0, 0.3);
        }

        /* Horizontal bar fill */
        .bar-fill {
            height: 100%;
            width: 0%;
            background: white;
            transition: width 0.6s ease;
            border-radius: 0;
        }

        /* Winner bar fill */
        .bar-row.winner .bar-fill {
            background: linear-gradient(90deg, #FFD700, #FFA500);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.6);
        }

        /* Percentage label - always visible */
        .bar-percent {
            position: absolute;
            right: 24px;
            font-size: 40px;
            font-weight: bold;
            z-index: 10;
            background: rgba(0, 0, 0, 0.8);
            padding: 6px 14px;
            border-radius: 4px;
            border: 2px solid white;
            line-height: 1.2;
            min-width: 70px;
            text-align: center;
        }

        /* Winner percentage */
        .bar-row.winner .bar-percent {
            background: rgba(255, 215, 0, 0.9);
            color: black;
            border-color: #FFA500;
        }
    </style>
</head>
<body>
<div id="chart-container">
    <div id="chart"></div>
</div>

<script>
    let bars = {};

    async function init() {
        await updateResults();
        setInterval(updateResults, 1000);
    }

    async function updateResults() {
        try {
            const resp = await fetch("/api/get-results");
            if (!resp.ok) return;

            const res = await resp.json();
            if (!res || !res.result) return;

            updateChart(res.result);
        } catch (e) {
            console.error(e);
        }
    }

    function updateChart(results) {
        const chart = document.getElementById("chart");
        if (!chart) return;

        const totalVotes = results.reduce((s, r) => s + r[1], 0);

        // Clear existing bars to ensure proper reordering
        Object.values(bars).forEach(({ row }) => row.remove());
        bars = {};

        results
            .sort((a, b) => b[1] - a[1])
            .forEach(([name, votes], index) => {
                const percent = totalVotes > 0
                    ? (votes / totalVotes) * 100
                    : 0;

                const row = document.createElement("div");
                row.classList.add("bar-row");

                // **FIXED: Add winner class BEFORE setting className**
                if (index === 0) {
                    row.classList.add("winner");
                }

                const header = document.createElement("div");
                header.className = "bar-header";

                const nameEl = document.createElement("div");
                nameEl.className = "bar-name";
                nameEl.textContent = name;

                const votesEl = document.createElement("div");
                votesEl.className = "bar-votes";

                const barContainer = document.createElement("div");
                barContainer.className = "bar-container";

                const percentEl = document.createElement("div");
                percentEl.className = "bar-percent";

                const barBg = document.createElement("div");
                barBg.className = "bar-bg";

                const barFill = document.createElement("div");
                barFill.className = "bar-fill";

                barBg.appendChild(barFill);
                barContainer.append(percentEl, barBg);
                header.append(nameEl, votesEl);
                row.append(header, barContainer);
                chart.appendChild(row);

                bars[name] = { row, barFill, percentEl, votesEl };

                barFill.style.width = percent + "%";
                percentEl.textContent = percent.toFixed(1) + "%";
                votesEl.textContent = votes + " Stimmen";
            });
    }

    window.addEventListener("load", init);
</script>
</body>
</html>
